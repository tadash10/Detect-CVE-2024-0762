import subprocess
import re
import platform
import sys
import logging

# Setup logging for security and troubleshooting
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

def execute_command(command):
    """Execute a command and return its output."""
    try:
        result = subprocess.check_output(command, text=True, stderr=subprocess.STDOUT)
        return result
    except subprocess.CalledProcessError as e:
        logging.error(f"Command '{' '.join(command)}' failed with exit code {e.returncode}. Output: {e.output}")
        sys.exit(1)
    except Exception as e:
        logging.error(f"Unexpected error executing command '{' '.join(command)}': {e}")
        sys.exit(1)

def get_uefi_version():
    """Retrieve the UEFI firmware version."""
    try:
        if platform.system() == 'Windows':
            command = ['wmic', 'bios', 'get', 'smbiosbiosversion']
            result = execute_command(command)
            # Extract the firmware version from the command output
            version_match = re.search(r'(\d+\.\d+)', result)
            if version_match:
                version = version_match.group(1)
            else:
                logging.error("Failed to extract version from Windows command output.")
                sys.exit(1)
                
        elif platform.system() == 'Linux':
            try:
                with open('/sys/class/dmi/id/bios_version', 'r') as file:
                    result = file.read()
                # Extract the firmware version from the command output
                version_match = re.search(r'(\d+\.\d+)', result)
                if version_match:
                    version = version_match.group(1)
                else:
                    logging.error("Failed to extract version from Linux bios_version file.")
                    sys.exit(1)
            except FileNotFoundError:
                logging.error("BIOS version file not found on Linux system.")
                sys.exit(1)
                
        else:
            logging.error("Unsupported OS for firmware version detection.")
            sys.exit(1)
        
        return version.strip()
    
    except Exception as e:
        logging.error(f"Unexpected error retrieving UEFI firmware version: {e}")
        sys.exit(1)

def check_vulnerability(version):
    """Check if the firmware version is vulnerable to CVE-2024-0762."""
    # List of known vulnerable versions. Ensure these are updated regularly.
    vulnerable_versions = {
        '1.0': 'vulnerable_version_1',
        '2.0': 'vulnerable_version_2',
        # Add actual vulnerable firmware versions here
    }
    
    if version in vulnerable_versions:
        logging.info(f"Firmware version {version} is vulnerable.")
        return True
    return False

def main():
    """Main function to run the detection script."""
    logging.info("Starting detection for CVE-2024-0762...")
    version = get_uefi_version()
    logging.info(f"Detected UEFI firmware version: {version}")
    
    if check_vulnerability(version):
        logging.warning("Vulnerability CVE-2024-0762 detected!")
        # Optional: Add additional actions, e.g., send an alert or trigger a remediation process
    else:
        logging.info("No vulnerability detected.")

if __name__ == "__main__":
    main()
